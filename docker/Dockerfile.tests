FROM dockerregistry.ondewo.com:5000/ubuntu:18.04 AS private_installer
ARG SSH_PRIVATE_KEY
RUN mkdir /root/install
WORKDIR /root/install
RUN mkdir /root/.ssh/
RUN echo "${SSH_PRIVATE_KEY}" > /root/.ssh/id_rsa
RUN chmod 600 /root/.ssh/id_rsa
RUN echo "StrictHostKeyChecking no" >> /root/.ssh/config

RUN apt-get update && apt-get -y upgrade && \
	apt-get install -y git

RUN git clone git@bitbucket.org:ondewo/ondewo-t2s-glow.git
RUN cd ondewo-t2s-glow && git checkout ac7cf48df6e40ea6935b0bc51232374fa5efc6a0

RUN git clone git@bitbucket.org:ondewo/tensorflowtts.git
RUN cd tensorflowtts && git checkout 17963fd905eb04a73338681a440e6c2fa71e47a8

FROM dockerregistry.ondewo.com:5000/cuda:11.0-base-ubuntu18.04 AS uncythonized

RUN apt-get update && apt-get -y upgrade && \
	apt-get install -y git

# Upgrade installed packages
RUN apt-get update && apt-get upgrade -y && apt-get install -y libsndfile1-dev

# Install Python 3.7
RUN apt-get install -y curl python3.7 python3.7-dev python3.7-distutils && \
    update-alternatives --install /usr/bin/python python /usr/bin/python3.7 1 && \
    update-alternatives --set python /usr/bin/python3.7 && \
    curl -s https://bootstrap.pypa.io/get-pip.py -o get-pip.py && \
    python get-pip.py --force-reinstall && \
    rm get-pip.py

# Install TF
RUN pip install tensorflow-gpu==2.3.0

# Install PyTorch
RUN pip install torch==1.6.0

# Install NeMo
RUN pip install nemo_toolkit[all]==0.11

RUN pip install cython
COPY --from=private_installer /root/install/ondewo-t2s-glow ./ondewo-t2s-glow
RUN cd ondewo-t2s-glow/monotonic_align; python setup.py build_ext --inplace; cd ../..
RUN pip install -e ondewo-t2s-glow

COPY --from=private_installer /root/install/tensorflowtts ./tensorflowtts
RUN pip install -e tensorflowtts

COPY ./docker/batch_server_requirements.txt .
RUN pip install nvidia-pyindex
RUN pip install -r batch_server_requirements.txt --ignore-installed

WORKDIR /opt/ondewo-t2s
COPY ./normalization ./normalization
COPY ./inference ./inference
COPY ./batch_server ./batch_server
COPY ./utils ./utils
COPY ./tests ./tests
COPY ./config ./config
COPY ./grpc_config_server ./grpc_config_server
COPY ./tests/tests_grpc/offline/models ./models

ENV PYTHONPATH /opt/ondewo-t2s
CMD python -m pytest -vv --capture=no --junit-xml=log/"$TESTFILE" --ignore="tests/e2e" --ignore="tests/integration"